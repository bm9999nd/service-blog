<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scanner</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <link rel="stylesheet" href="/server/css/global.css">

    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script>
        $.ajax("/server/view/portfolio/template/btn-dark.html").done(x => $('body').append(x));
    </script>
</head>
<body>
    <style>
        .scanner {
            height: auto;
            width: 300px;
            min-height: 200px;
            border-radius: 1rem;
            background-color: black;
        }
        .scanner video {
            width: 100%;
            height: auto;
            border-radius: 1rem;
        }
        .player {
            --btn-sz: 85px;
            width: var(--btn-sz);
            height: var(--btn-sz);
        }
        iframe {
            width: 100%;
            height: 100%;
        }
        p, span, div, br {
            cursor: default;
            user-select: none;
        }
        label, input {
            cursor: pointer;
        }
    </style>

    <audio src="https://www.soundjay.com/buttons/beep-08b.mp3" id="audio"></audio>

    <!-- scanner -->
    <div class="container vh-100 py-3">
        <!-- scanner -->
        <div class="d-grid justify-content-center mb-3">
            <!-- video -->
            <div>
                <div id="reader" class="scanner shadow"></div>
            </div>
            
            <!-- result -->
            <div class="text-center">
                <div><h3>Scanned Result</h3></div>
                <div id="result">
                    Nothing scanned yet!
                </div>
            </div>
        </div>

        <!-- search -->
        <div></div>

        <!-- controller -->
        <div class="fixed-bottom">
            <div class="text-center">
                <button type="button" 
                    class="btn btn-primary rounded-circle my-3 player">
                    <i class="bi bi-qr-code-scan display-5"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- modal -->
    <div id="modal" class="modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Camera</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Select a camera to use for barcode scan :</p>

                    <div class="cam-select"></div>
                </div>
                <div class="modal-footer">
                    <div class="d-flex justify-content-between w-100">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" disabled>Select</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <template id="tmp-radio">
        <div class="form-check mb-3">
            <input id="" name="camera" value="" class="form-check-input" type="radio">
            <label for="" class="form-check-label w-100">
                -
            </label>
        </div>
    </template>

    <!-- script modal -->
    <script>
        const evSelect = "camSelect";
        const modal = new bootstrap.Modal('#modal', {
            backdrop: true,
            focus: true,
            keyboard: true,
        });

        function renderModal(items = []) {
            const mod = $('#modal');
            const ul = mod.find('.cam-select');
            ul.children().remove();

            items.forEach(item => {
                const li = $($('#tmp-radio').clone().html());
                const id = item.id;
                li.find('label').attr('for', id).html(item.label);
                li.find('input').attr('id', id).val(id).on("input", e => {
                    const btn = mod.find(".btn-primary");
                    btn.prop("disabled", false);
                });
                li.appendTo(ul);
            });

            modal.show();
        }

        $('#modal .btn-primary').on("click", e => {
            const sel = $("#modal [name='camera']:checked").val();
            if (sel != null) {
                document.dispatchEvent(new CustomEvent(evSelect, {
                    detail: sel,
                }));
                modal.hide();
            } else {
                alert('Camera not selected!');
            }
        });
    </script>

    <!-- script scanner -->
    <script type="text/javascript">
        const eventScanName = "scanState";
        const audio = $('#audio')[0];
        let scanner;

        async function getCamera() {
            try {
                const exist = await Html5Qrcode.getCameras();
                if (!exist || exist.length == 0) {
                    return console.error('no camera found!');
                }
                
                console.log('Cameras:\n', exist);
                renderModal(exist);
            } catch (error) {
                alert(error.message);
            }
        }

        function scanning(camId, videoId, resultId, eventName = "scanned", singleScan = true) {
            const html5QrCode = new Html5Qrcode(videoId, false);
            const result = $(`#${resultId}`);

            async function start() {
                try {
                    document.dispatchEvent(new CustomEvent(eventScanName, {
                        detail: true,
                    }));

                    const play = await html5QrCode.start(camId, {
                            fps: 10,    // Optional, frame per seconds for qr code scanning
                            qrbox: { width: 250, height: 250 },  // Optional, if you want bounded box UI
                        }, (decodedText, decodedResult) => {
                            // do something when code is ready
                            audio.play();
                            result[0].dispatchEvent(new CustomEvent(eventName, {
                                detail: {
                                    text: decodedText,
                                    result: decodedResult,
                                }
                            }));
                            if (singleScan) stop();
    
                        }, (errorMessage) => {
                            // parse error, ignore it.
                        });
    
                } 
                
                // Start failed, handle it.
                catch (err) {
                    console.warn('failed to start camera:\n', err);
                    document.dispatchEvent(new CustomEvent(eventScanName, {
                        detail: false,
                    }));
                    alert(err.message);
                }
            }

            async function stop() {
                try {
                    const stopped = await html5QrCode.stop();
                    // QR Code scanning is stopped.
                    document.dispatchEvent(new CustomEvent(eventScanName, {
                        detail: false,
                    }));
                    
                } catch (err) {
                    // Stop failed, handle it.
                }
            }

            return {
                start,
                stop,
                scanner: html5QrCode,
            }
        }

        $("#result").on("scanned", e => {
            console.info('decoded text:\n', e.detail.text, 'decoded result:\n', e.detail.result);
            const c = $(e.target);
            c.html(e.detail.result);
        });

        $(document).on(eventScanName, e => {
            const isPlay = e.detail;
            const btn = $('button.player');

            if (!isPlay) scanner = undefined;
            setCss(isPlay);

            function setCss(isPlaying) {
                const icon = btn.find('i');
                const img = {
                    playBtn: 'btn-primary',
                    stopBtn: 'btn-danger',
                    playIcon: 'bi-qr-code-scan',
                    stopIcon: 'bi-stop-fill',
                };

                btn.toggleClass(img.playBtn, !isPlaying);
                icon.toggleClass(img.playIcon, !isPlaying);
                btn.toggleClass(img.stopBtn, isPlaying);
                icon.toggleClass(img.stopIcon, isPlaying);
            }
        });

        $(document).on(evSelect, e => {
            const camId = e.detail;
            scanner = scanning(camId, "reader", "result");
            
            console.log('Status:', scanner.scanner);
            scanner.start();
        });

        $('button.player').on("click", e => {
            if (typeof scanner != "undefined") scanner.stop();
            else getCamera();
        });

    </script>
</body>
</html>